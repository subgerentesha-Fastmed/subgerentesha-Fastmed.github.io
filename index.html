<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Unificada de Reportes SHA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Librerías para Análisis y Exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-to-docx@1.8.0/dist/html-to-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c1021;
            background-image: radial-gradient(ellipse 80% 80% at 0% 50%, rgba(0, 85, 255, 0.5) 0%, transparent 100%), radial-gradient(ellipse 80% 80% at 100% 50%, rgba(255, 0, 51, 0.5) 0%, transparent 100%);
            background-attachment: fixed;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #1e3a8a;
            color: white;
            border-bottom: 3px solid #f59e0b;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            opacity: 0;
            transition: all 0.5s ease-in-out;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }
        .fade-in-slide-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilos para el informe generado */
        .report-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        .report-content h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
         .report-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .report-content p {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        .report-content ul {
            list-style-position: inside;
            list-style-type: disc;
            margin-bottom: 1rem;
            padding-left: 1rem;
        }
        .report-content ul li {
            margin-bottom: 0.25rem;
        }

        @media print {
            .print-hidden { display: none; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

    <!-- Mensajes Globales -->
    <div id="message-box" class="message-box"></div>
    <div id="globalSpinner" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex justify-center items-center z-[60]">
        <div class="spinner"></div>
        <p class="ml-4 text-white text-lg">Procesando...</p>
    </div>

    <div class="w-full max-w-5xl mb-16">
        <div class="flex flex-col items-center mb-6">
            <img src="https://static.wixstatic.com/media/8b1764_8e8af4e9fbd54ef085bc68a18999d35d~mv2.png/v1/fill/w_540,h_222,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/2-fondo%20blanco%20horizontal%202.png" alt="Logo SHA-PROSALMED" class="h-20 mb-4">
            <h1 class="text-3xl font-bold text-white text-center">Herramienta de Gestión de Actividades SHA</h1>
        </div>
        
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full">
            <!-- Pestañas de Navegación -->
            <div class="flex justify-center border-b-2 border-gray-200 mb-6">
                <button id="tab-registro" class="tab-button px-6 py-3 font-semibold text-gray-600 active focus:outline-none">Registro de Actividades</button>
                <button id="tab-supervisor" class="tab-button px-6 py-3 font-semibold text-gray-600 focus:outline-none">Panel Supervisor</button>
            </div>

            <!-- Contenido Pestaña 1: Registro de Actividades -->
            <div id="content-registro">
                <section>
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-red-400 pb-2">Registrar Nueva Jornada</h2>
                    <form id="reportForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <!-- Campos del formulario -->
                        <div>
                            <label for="reportDate" class="block text-gray-700 text-sm font-semibold mb-2">Fecha:</label>
                            <input type="date" id="reportDate" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="coordinator" class="block text-gray-700 text-sm font-semibold mb-2">Responsable SHA:</label>
                            <select id="coordinator" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="" disabled selected>Cargando responsables...</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                             <label for="location" class="block text-gray-700 text-sm font-semibold mb-2">Cliente:</label>
                            <select id="location" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                 <option value="" disabled selected>Cargando clientes...</option>
                            </select>
                        </div>
                        <div>
                            <label for="startTime" class="block text-gray-700 text-sm font-semibold mb-2">Hora Inicio:</label>
                            <input type="time" id="startTime" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="endTime" class="block text-gray-700 text-sm font-semibold mb-2">Hora Fin:</label>
                            <input type="time" id="endTime" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2 text-center mt-2 p-3 bg-blue-50 rounded-lg text-blue-800 font-bold text-lg">
                            <span id="elapsedTimeDisplay">Tiempo Transcurrido: --</span>
                        </div>
                        <div class="md:col-span-2">
                            <label for="activities" class="block text-gray-700 text-sm font-semibold mb-2">Actividades Realizadas:</label>
                             <div id="activityButtons" class="flex flex-wrap gap-2 mb-2">
                                <button type="button" class="activity-btn bg-sky-100 text-sky-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-sky-200 transition">Inspección de campo</button>
                                <button type="button" class="activity-btn bg-sky-100 text-sky-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-sky-200 transition">Reunión de seguridad</button>
                                <button type="button" class="activity-btn bg-sky-100 text-sky-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-sky-200 transition">Capacitación de personal</button>
                            </div>
                            <textarea id="activities" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe las actividades realizadas..."></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="observations" class="block text-gray-700 text-sm font-semibold mb-2">Observaciones:</label>
                            <div id="observationButtons" class="flex flex-wrap gap-2 mb-2">
                                 <button type="button" class="observation-btn bg-teal-100 text-teal-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-teal-200 transition">Jornada sin novedad</button>
                                 <button type="button" class="observation-btn bg-teal-100 text-teal-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-teal-200 transition">Se observó buen uso de EPP</button>
                            </div>
                            <textarea id="observations" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Añade cualquier observación relevante..."></textarea>
                        </div>
                        <!-- Botones de Acción -->
                        <div class="md:col-span-2 flex flex-col sm:flex-row flex-wrap justify-center items-center gap-4 mt-6">
                            <button type="button" id="saveReportBtn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Guardar Reporte</button>
                            <button type="button" id="generateWhatsAppBtn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none">Enviar por WhatsApp</button>
                            <button type="button" id="addToCalendarBtn" class="flex items-center justify-center gap-2 w-full sm:w-auto bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-full shadow-md transition duration-300 transform hover:scale-105">
                                <span class="text-xl">🗓️</span>
                                Agendar
                            </button>
                            <button type="button" id="clearFormBtn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none">Limpiar</button>
                        </div>
                    </form>
                </section>
            </div>

            <!-- Contenido Pestaña 2: Panel Supervisor -->
            <div id="content-supervisor" class="hidden">
                <div id="supervisor-login" class="flex flex-col items-center space-y-4 p-8">
                    <p class="text-lg font-semibold text-gray-700">Ingresa la clave de supervisor</p>
                    <input type="password" id="supervisor-key" class="w-full max-w-xs p-2 border rounded-md" placeholder="Clave de acceso">
                    <button id="login-button" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none">Acceder</button>
                </div>
                
                <div id="supervisor-dashboard" class="hidden">
                    <section class="p-4 bg-indigo-50 rounded-lg shadow-md border border-indigo-200">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b-2 border-indigo-400 pb-2">Análisis y Filtros</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                             <div>
                                <label for="filterStartDate" class="block text-sm font-semibold">Fecha Inicio:</label>
                                <input type="date" id="filterStartDate" class="w-full p-2 border rounded-lg bg-white mt-1">
                            </div>
                             <div>
                                <label for="filterEndDate" class="block text-sm font-semibold">Fecha Fin:</label>
                                <input type="date" id="filterEndDate" class="w-full p-2 border rounded-lg bg-white mt-1">
                            </div>
                            <div>
                                <label for="coordinatorFilter" class="block text-sm font-semibold">Filtrar por Responsable:</label>
                                <select id="coordinatorFilter" class="w-full p-2 border rounded-lg bg-white mt-1"></select>
                            </div>
                            <div>
                                <label for="locationFilter" class="block text-sm font-semibold">Filtrar por Cliente:</label>
                                <select id="locationFilter" class="w-full p-2 border rounded-lg bg-white mt-1"></select>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-4">
                            <button id="applyFiltersBtn" class="px-6 py-2 bg-purple-500 text-white font-bold rounded-full">Aplicar Filtros</button>
                            <button id="clearFiltersBtn" class="px-6 py-2 bg-gray-400 text-white font-bold rounded-full">Limpiar</button>
                            <button id="generateReportBtn" class="px-6 py-2 bg-teal-500 text-white font-bold rounded-full">Generar Informe</button>
                        </div>
                    </section>
                    
                    <!-- Sección de Administración -->
                    <section id="admin-section" class="mt-6 p-4 bg-red-50 rounded-lg shadow-md border border-red-200">
                        <div id="admin-login" class="text-center">
                             <h2 class="text-xl font-semibold text-gray-800 mb-4">Acceso a Administración</h2>
                             <p class="text-gray-600 mb-4">Ingrese la clave de supervisor para gestionar clientes y responsables.</p>
                             <div class="flex justify-center items-center gap-2">
                                <input type="password" id="admin-key" class="w-full max-w-xs p-2 border rounded-md" placeholder="Clave de acceso">
                                <button id="admin-login-button" class="px-6 py-2 bg-red-600 text-white font-bold rounded-full">Desbloquear</button>
                             </div>
                        </div>
                        <div id="admin-controls" class="hidden text-center">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Gestión de Listas</h2>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button id="manageClientsBtn" class="px-6 py-2 bg-blue-500 text-white font-bold rounded-full">Gestionar Clientes</button>
                                <button id="manageCoordinatorsBtn" class="px-6 py-2 bg-green-500 text-white font-bold rounded-full">Gestionar Responsables</button>
                            </div>
                        </div>
                    </section>

                    <section id="analyticsSection" class="hidden mt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b-2 border-yellow-500 pb-2">Estadísticas</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                           <div id="clientTimeChart" class="bg-white p-4 rounded-lg shadow-md h-80"></div>
                           <div id="coordinatorTimeChart" class="bg-white p-4 rounded-lg shadow-md h-80"></div>
                        </div>
                    </section>

                    <section class="mt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b-2 border-gray-400 pb-2">Historial de Reportes</h3>
                        <div id="pastParsedReportsList" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                    </section>

                    <section id="reportContainer" class="mt-6"></section>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Informe -->
    <div id="editReportModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                 <h3 class="text-xl font-semibold">Editar Informe Antes de Descargar</h3>
                 <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="editableReportContent" class="p-6 overflow-y-auto" contenteditable="true" style="min-height: 400px; border: 1px solid #ddd;"></div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-4">
                <button id="cancelEditBtn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-full">Cancelar</button>
                <button id="saveAndDownloadBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full">Guardar y Descargar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Gestión (Clientes/Responsables) -->
    <div id="managementModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-4 border-b flex justify-between items-center">
                 <h3 id="managementModalTitle" class="text-xl font-semibold">Gestionar</h3>
                 <button id="closeManagementModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="newItemInput" class="block text-sm font-semibold mb-2">Añadir Nuevo:</label>
                    <div class="flex gap-2">
                        <input type="text" id="newItemInput" class="w-full p-2 border rounded-md" placeholder="Nombre...">
                        <button id="addNewItemBtn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md">Añadir</button>
                    </div>
                </div>
                <h4 class="font-semibold mb-2">Lista Actual:</h4>
                <ul id="managementList" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded-md">
                    <!-- Los items se cargarán aquí -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="confirmDeleteModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-[70] p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-red-500 w-14 h-14" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="mb-5 text-lg font-normal text-gray-700">¿Estás seguro de que quieres eliminar este elemento?</h3>
                <p id="itemToDeleteName" class="mb-5 text-sm font-bold text-gray-900"></p>
                <button id="confirmDeleteBtn" type="button" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
                    Sí, estoy seguro
                </button>
                <button id="cancelDeleteBtn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                    No, cancelar
                </button>
            </div>
        </div>
    </div>


    <footer class="text-center text-gray-300 text-sm mt-8 pb-4">
        &copy; 2025 Derechos Reservados Sha-Prosalmed
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, query, onSnapshot, serverTimestamp, doc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBs3bNWa_omjW0kecM1fwchPZNqPVfOL28",
            authDomain: "reporte-sha-base-sup.firebaseapp.com",
            projectId: "reporte-sha-base-sup",
            storageBucket: "reporte-sha-base-sup.appspot.com",
            messagingSenderId: "46767598600",
            appId: "1:46767598600:web:d70cf029c42718a94575bd",
            measurementId: "G-J09J1FPHR9"
        };
        
        let app, db, auth;
        let userId = null;
        let allReports = [];
        let filteredReports = [];
        let allClientsList = [];
        let allCoordinatorsList = [];
        const SUPERVISOR_KEY = 'sha2025';
        
        // --- UI HELPER FUNCTIONS ---
        function showMessage(message, type = 'info', duration = 4000) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'message-box p-4 rounded-lg shadow-xl text-white font-semibold';
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            box.classList.add(colors[type], 'show');
            setTimeout(() => box.classList.remove('show'), duration);
        }

        function showSpinner(show) {
            document.getElementById('globalSpinner').classList.toggle('hidden', !show);
        }

        function switchTab(targetTab) {
            const tabs = ['registro', 'supervisor'];
            tabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).classList.remove('active');
                document.getElementById(`content-${tab}`).classList.add('hidden');
            });
            document.getElementById(`tab-${targetTab}`).classList.add('active');
            document.getElementById(`content-${targetTab}`).classList.remove('hidden');
        }

        // --- DATE & TIME FUNCTIONS ---
        function calculateElapsedTime(start, end) {
            if (!start || !end) return '--';
            const diffMs = new Date(`1970-01-01T${end}:00`) - new Date(`1970-01-01T${start}:00`);
            const diffMinutes = Math.round(diffMs / 60000);
            if (diffMinutes < 0) return 'Horas inválidas';
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            return `${hours} horas ${minutes} minutos`;
        }
        
        function formatGoogleCalendarDate(dateObj) {
            return dateObj.toISOString().replace(/-|:|\.\d{3}/g, '');
        }

        function formatMinutesToHours(minutes) {
            if (isNaN(minutes)) return "0h 0m";
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return `${hours}h ${mins}m`;
        }
        
        function formatMinutesToLongHours(totalMinutes) {
            if (isNaN(totalMinutes)) return "0 horas 0 minutos";
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            return `${hours} horas ${minutes} minutos`;
        }

        // --- FIREBASE & DATA HANDLING ---
        async function initializeFirebase() {
            if (!Object.keys(firebaseConfig).length) return showMessage('Error de configuración de Firebase.', 'error');
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await seedInitialData(); // Carga los datos iniciales si es necesario
                    setupReportsListener();
                    setupListListener('clients', populateClientDropdowns);
                    setupListListener('coordinators', populateCoordinatorDropdowns);
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) { console.error("Auth Error:", e); showMessage('Error de autenticación.', 'error'); }
                }
            });
        }
        
        async function seedInitialData() {
            // Seed Clients
            const clientsRef = collection(db, 'clients');
            const clientsSnapshot = await getDocs(clientsRef);
            if (clientsSnapshot.empty) {
                console.log("Seeding initial clients...");
                const clientNames = ["A&S CONSULTORES, C.A.", "ADMINISTRADORA 302, C.A.", "ASOCIACION VENEZOLANA DE LA IGLESIA DE JESUCRISTO DE LOS SANTOS DE LOS ULTIMOS DIAS", "BAYER, S.A.", "CAMARA VENEZOLANO AMERICANA DE COMERCIO E INDUSTRIA (VENAMCHAM)", "CARACAS SOUL C.A.", "CHOCOBRU INT.CHOCOLATE IMP. REG. CAP. C.A.", "CONDOMINIO CENTRO COMERCIAL CITY MARKET", "CONSORCIO DE VALORES E INVERSIONES COVAIN. C.A.", "DESARROLLOS HOTELEROS LA CASTELLENA S.C.S.", "DICAM SISTEMAS INTELIGENTES C.A", "EAGLEBURGMANN VENEZUELA, C.A.", "GRUPO INFOGUIANET, C.A.", "GRUPO INTEXUS C.A", "H2 FOOD SERVICE, C.A.", "IMPORTADORA BICIMOTO LTDA C.A.", "INVERSIONES OTAPE C.A.", "INVERSIONES QUIMIVECO 3, C.A", "INVERSORA MELKIM", "MASTERCARD VENEZUELA, INC.", "OTAOLA INGENIERIA C.A.", "OXICORP, C.A.", "PEPSICO (MARACAY)", "PROMOTORA 204 C.A.", "PROSALMED C.A. CCCT", "PROSALMED C.A. SBG", "PROSALMED C.A. SEDE PRINCIPAL", "SNACKS (MARACAIBO)", "SNACKS (MARACAY)", "SNACKS (PTO ORDAZ)", "SNACKS (VALENCIA)", "TELEFONICA", "VAN DER IMPORT, C.A", "OTRO"];
                const batch = writeBatch(db);
                clientNames.forEach(name => {
                    const docRef = doc(clientsRef);
                    batch.set(docRef, { name });
                });
                await batch.commit();
            }

            // Seed Coordinators
            const coordinatorsRef = collection(db, 'coordinators');
            const coordinatorsSnapshot = await getDocs(coordinatorsRef);
            if (coordinatorsSnapshot.empty) {
                console.log("Seeding initial coordinators...");
                const coordinatorNames = ["Adelvy Piñango", "Arturo Gomez", "Carlos Vera", "Damiany Reyes", "Daniel García", "Darwin Gómez", "Douglas Vásquez", "Erika Piñero", "Francisco Enrique", "Gregvir Rodríguez", "Izkarlette Rodríguez", "José Cova", "Karem Doriela", "María Hernández", "Osmel Ventura", "Wilmer Peña", "Yoraco Gonzalez", "Yris Parra", "Neomar Funes"];
                const batch = writeBatch(db);
                coordinatorNames.forEach(name => {
                    const docRef = doc(coordinatorsRef);
                    batch.set(docRef, { name });
                });
                await batch.commit();
            }
        }

        async function saveReportToFirebase(reportData) {
            if (!userId || !db) return showMessage('Error: No se puede conectar a la base de datos.', 'error');
            showSpinner(true);
            try {
                await addDoc(collection(db, "shaReports"), { ...reportData, timestamp: serverTimestamp(), userId });
                showMessage('Reporte guardado exitosamente.', 'success');
                document.getElementById('reportForm').reset();
                setDefaults();
            } catch (error) {
                console.error("Error saving report:", error);
                showMessage('Error al guardar el reporte.', 'error');
            } finally {
                showSpinner(false);
            }
        }

        function setupReportsListener() {
            const q = query(collection(db, "shaReports"));
            onSnapshot(q, (snapshot) => {
                allReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allReports.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                populateFilterDropdowns();
                applyFilters();
            }, (error) => console.error("Error listening to reports:", error));
        }
        
        function setupListListener(listName, populateFunction) {
            const manageClientsBtn = document.getElementById('manageClientsBtn');
            const manageCoordinatorsBtn = document.getElementById('manageCoordinatorsBtn');
            const q = query(collection(db, listName));
            
            return onSnapshot(q, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => a.name.localeCompare(b.name));
                
                if (listName === 'clients') {
                    allClientsList = items;
                    manageClientsBtn.disabled = false;
                    manageClientsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else if (listName === 'coordinators') {
                    allCoordinatorsList = items;
                    manageCoordinatorsBtn.disabled = false;
                    manageCoordinatorsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                populateFunction(items);
            }, (error) => console.error(`Error listening to ${listName}:`, error));
        }

        async function addListItem(collectionName, itemName) {
            const trimmedItemName = itemName.trim();
            if (!trimmedItemName) {
                return showMessage('El nombre no puede estar vacío.', 'error');
            }
            
            const listToCheck = collectionName === 'clients' ? allClientsList : allCoordinatorsList;
            const isDuplicate = listToCheck.some(item => item.name.toLowerCase() === trimmedItemName.toLowerCase());

            if (isDuplicate) {
                return showMessage(`"${trimmedItemName}" ya existe en la lista.`, 'error');
            }

            showSpinner(true);
            try {
                await addDoc(collection(db, collectionName), { name: trimmedItemName });
                showMessage('Elemento añadido exitosamente.', 'success');
            } catch (error) {
                console.error("Error adding item:", error);
                showMessage('No se pudo añadir el elemento.', 'error');
            } finally {
                showSpinner(false);
            }
        }

        // --- REGISTRO TAB LOGIC ---
        function getFormData() {
            const data = {
                reportDate: document.getElementById('reportDate').value,
                coordinator: document.getElementById('coordinator').value,
                location: document.getElementById('location').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                activities: document.getElementById('activities').value.trim(),
                observations: document.getElementById('observations').value.trim(),
            };
            const elapsedTime = calculateElapsedTime(data.startTime, data.endTime);
            if (!data.reportDate || !data.coordinator || !data.location || !data.startTime || !data.endTime || !data.activities) {
                showMessage('Por favor, complete todos los campos requeridos.', 'error');
                return null;
            }
            data.elapsedTime = elapsedTime;
            const diffMs = new Date(`1970-01-01T${data.endTime}:00`) - new Date(`1970-01-01T${data.startTime}:00`);
            data.elapsedMinutes = diffMs > 0 ? diffMs / 60000 : 0;
            return data;
        }
        
        function populateCoordinatorDropdowns(coordinators) {
             const select = document.getElementById('coordinator');
             select.innerHTML = '<option value="" disabled selected>Selecciona un responsable</option>' + 
                                coordinators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }
        
        function populateClientDropdowns(clients) {
            const select = document.getElementById('location');
            select.innerHTML = '<option value="" disabled selected>Selecciona un cliente</option>' + 
                               clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }


        function setDefaults() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('elapsedTimeDisplay').textContent = `Tiempo Transcurrido: --`;
        }

        // --- SUPERVISOR TAB LOGIC ---
        function populateFilterDropdowns() {
            const coordinatorFilter = document.getElementById('coordinatorFilter');
            const locationFilter = document.getElementById('locationFilter');
            const uniqueCoordinators = [...new Set(allReports.map(r => r.coordinator).filter(Boolean))].sort();
            const uniqueLocations = [...new Set(allReports.map(r => r.location).filter(Boolean))].sort();
            
            coordinatorFilter.innerHTML = '<option value="">Todos los Responsables</option>' + uniqueCoordinators.map(c => `<option value="${c}">${c}</option>`).join('');
            locationFilter.innerHTML = '<option value="">Todos los Clientes</option>' + uniqueLocations.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function applyFilters() {
            const coordinator = document.getElementById('coordinatorFilter').value;
            const location = document.getElementById('locationFilter').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            filteredReports = allReports.filter(r => 
                (!coordinator || r.coordinator === coordinator) &&
                (!location || r.location === location) &&
                (!startDate || r.reportDate >= startDate) &&
                (!endDate || r.reportDate <= endDate)
            );
            displayPastReports(filteredReports);
            generateAnalytics(filteredReports);
        }
        
        function displayPastReports(reports) {
            const list = document.getElementById('pastParsedReportsList');
            if (reports.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">No hay reportes que coincidan.</p>';
                return;
            }
            list.innerHTML = reports.map((r, i) => `
                <div class="bg-gray-50 p-3 rounded-lg shadow-sm border fade-in-slide-up" style="animation-delay: ${i * 0.05}s;">
                    <p class="font-semibold text-gray-700">🗓️ ${r.reportDate || 'N/A'}</p>
                    <p class="text-sm">🧑‍💼 Responsable: ${r.coordinator || 'N/A'}</p>
                    <p class="text-sm">📍 Cliente: ${r.location || 'N/A'}</p>
                    <p class="text-sm">⏳ Tiempo: <span class="font-medium text-blue-600">${r.elapsedTime || 'N/A'}</span></p>
                </div>
            `).join('');
        }

        function generateAnalytics(reports) {
            const section = document.getElementById('analyticsSection');
            if (reports.length === 0) return section.classList.add('hidden');
            section.classList.remove('hidden');

            const totalMinutes = d3.sum(reports, d => d.elapsedMinutes || 0);
            const locationData = d3.rollups(reports, v => d3.sum(v, d => d.elapsedMinutes || 0), d => d.location)
                .map(([name, val]) => ({ name, value: val })).sort((a,b) => b.value - a.value);
            renderBarChart('#clientTimeChart', locationData, 'Distribución por Cliente', totalMinutes);
            
            const coordinatorData = d3.rollups(reports, v => d3.sum(v, d => d.elapsedMinutes || 0), d => d.coordinator)
                .map(([name, val]) => ({ name, value: val })).sort((a,b) => b.value - a.value);
            renderBarChart('#coordinatorTimeChart', coordinatorData, 'Distribución por Responsable', totalMinutes);
        }

        function renderBarChart(selector, data, title, totalValue) {
            const container = d3.select(selector);
            container.select('svg').remove();
            const margin = {top: 40, right: 20, bottom: 80, left: 60},
                  width = container.node().offsetWidth - margin.left - margin.right,
                  height = 280 - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            
            const x = d3.scaleBand().range([0, width]).domain(data.map(d => d.name)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");
            
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value) || 1]).range([height, 0]);
            svg.append("g").call(d3.axisLeft(y).tickFormat(d => formatMinutesToHours(d)));
            
            svg.selectAll("rect").data(data).enter().append("rect")
                .attr("x", d => x(d.name)).attr("width", x.bandwidth()).attr("fill", "#6366F1")
                .attr("y", height).attr("height", 0)
                .transition().duration(700).delay((d,i) => i*50)
                .attr("y", d => y(d.value)).attr("height", d => height - y(d.value));

            svg.append("text").attr("x", width/2).attr("y", -20).attr("text-anchor", "middle").style("font-size", "1rem").style("font-weight", "600").text(title);
        }
        
        function generateDetailedReport() {
            const container = document.getElementById('reportContainer');
            if (filteredReports.length === 0) return showMessage('No hay datos para generar un informe.', 'info');
            
            const reportsForPeriod = [...filteredReports].sort((a, b) => new Date(a.reportDate) - new Date(b.reportDate));
            const totalMinutes = d3.sum(reportsForPeriod, d => d.elapsedMinutes || 0);
            const responsable = document.getElementById('coordinatorFilter').value || "Todos los responsables";
            const cliente = document.getElementById('locationFilter').value || "Todos los clientes";
            const firstReportDate = reportsForPeriod[0]?.reportDate;
            const lastReportDate = reportsForPeriod[reportsForPeriod.length - 1]?.reportDate;
            const periodo = `DEL ${firstReportDate} AL ${lastReportDate}`;

            let clientDetailsHtml = '';
            const reportsByClient = d3.group(reportsForPeriod, d => d.location);

            reportsByClient.forEach((clientReports, clientName) => {
                let clientSection = `<h2>${clientName || 'Actividades Generales'}</h2>`;
                const inpsaselActivities = clientReports.filter(r => `${r.activities} ${r.observations}`.toLowerCase().match(/inpsasel|anexo 12|delegado de prevenci(o|ó)n|declaraci(o|ó)n jurada/));
                const planningActivities = clientReports.filter(r => `${r.activities} ${r.observations}`.toLowerCase().match(/cssl|comit(e|é) de ssl|planificaci(o|ó)n|estrategia|elaboraci(o|ó)n de material/));
                const fieldActivities = clientReports.filter(r => `${r.activities} ${r.observations}`.toLowerCase().match(/capacitaci(o|ó)n|formaci(o|ó)n|inspecci(o|ó)n|recorrido|verificaci(o|ó)n de epp|dotaci(o|ó)n/));
                
                clientSection += createSectionHTML('Puesta al día con INPSASEL', inpsaselActivities);
                clientSection += createSectionHTML('Planificación y Estrategia con el Comité de SSL', planningActivities);
                clientSection += createSectionHTML('Acciones y Formación en Campo', fieldActivities);
                clientDetailsHtml += clientSection;
            });

            function createSectionHTML(title, reports) {
                if (reports.length === 0) return '';
                let html = `<h3>${title}</h3><ul>`;
                reports.forEach(r => {
                    html += `<li>${r.activities.replace(/\n/g, ' ')} (${r.reportDate})</li>`;
                });
                return html + '</ul>';
            }

            const proximosPasos = `
                <h2>Próximos Pasos y Recomendaciones</h2>
                <p>Hemos logrado avances significativos, especialmente en la organización documental y la planificación estratégica. Para mantener este impulso, nuestro foco estará en:</p>
                <ul>
                    <li><strong>Ejecutar lo planificado:</strong> Concretar la actualización de los formatos de Rutagrama y Notificación de Riesgo.</li>
                    <li><strong>Continuar las evaluaciones:</strong> Seguir analizando puestos y áreas de trabajo para identificar y controlar cualquier nuevo riesgo.</li>
                    <li><strong>Mantener la constancia:</strong> Realizar las inspecciones programadas y continuar con las reuniones mensuales del Comité de SSL, asegurando la entrega puntual de la documentación en INPSASEL.</li>
                    <li><strong>Registrar el Servicio de SSL:</strong> Avanzar con el registro formal del Servicio de Seguridad y Salud en el Trabajo.</li>
                </ul>`;

            const finalReportHTML = `
                <div class="report-content">
                    <h1>INFORME DE GESTIÓN</h1>
                    <p><strong>PERÍODO:</strong> ${periodo}</p>
                    <p><strong>ASESOR SHA RESPONSABLE:</strong> ${responsable.toUpperCase()}</p>
                    <p>Durante este último período, dedicamos un total de <strong>${formatMinutesToLongHours(totalMinutes)}</strong> de servicio a fortalecer la gestión de Seguridad y Salud Laboral (SSL) en las instalaciones de <strong>${cliente}</strong>. A continuación, te presento un resumen de los logros más importantes y los próximos pasos a seguir.</p>
                    ${clientDetailsHtml}
                    ${proximosPasos}
                </div>`;
            
            container.innerHTML = `
                <div class="fade-in-slide-up border rounded-lg p-6 bg-gray-50">
                    ${finalReportHTML}
                    <div class="mt-8 pt-6 border-t text-center print-hidden">
                        <button id="downloadWordBtn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-full">Descargar Informe en Word</button>
                    </div>
                </div>`;
            
            document.getElementById('downloadWordBtn').addEventListener('click', () => {
                document.getElementById('editableReportContent').innerHTML = finalReportHTML;
                document.getElementById('editReportModal').classList.remove('hidden');
            });
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        function main() {
            const manageClientsBtn = document.getElementById('manageClientsBtn');
            const manageCoordinatorsBtn = document.getElementById('manageCoordinatorsBtn');
            manageClientsBtn.disabled = true;
            manageCoordinatorsBtn.disabled = true;
            manageClientsBtn.classList.add('opacity-50', 'cursor-not-allowed');
            manageCoordinatorsBtn.classList.add('opacity-50', 'cursor-not-allowed');

            initializeFirebase();
            setDefaults();

            document.getElementById('tab-registro').addEventListener('click', () => switchTab('registro'));
            document.getElementById('tab-supervisor').addEventListener('click', () => switchTab('supervisor'));

            const form = document.getElementById('reportForm');
            form.addEventListener('input', () => {
                const start = document.getElementById('startTime').value;
                const end = document.getElementById('endTime').value;
                document.getElementById('elapsedTimeDisplay').textContent = `Tiempo Transcurrido: ${calculateElapsedTime(start, end)}`;
            });

            document.getElementById('saveReportBtn').addEventListener('click', () => {
                const data = getFormData();
                if (data) saveReportToFirebase(data);
            });
            
            document.getElementById('generateWhatsAppBtn').addEventListener('click', () => {
                const data = getFormData();
                if (!data) return;
                const text = `*REPORTE JORNADA SHA* ✅\n🗓️ *FECHA:* ${data.reportDate}\n...`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            });

            document.getElementById('addToCalendarBtn')?.addEventListener('click', function() { /* ... */ });
            document.getElementById('clearFormBtn').addEventListener('click', () => { if (confirm('¿Limpiar?')) { form.reset(); setDefaults(); } });
            
            document.querySelectorAll('.activity-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const textarea = document.getElementById('activities');
                    const newText = `- ${button.textContent.trim()}`;
                    textarea.value = textarea.value.trim() === '' ? newText : `${textarea.value.trim()}\n${newText}`;
                });
            });

            document.querySelectorAll('.observation-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const textarea = document.getElementById('observations');
                    const newText = button.textContent.trim();
                    textarea.value = textarea.value.trim() === '' ? newText : `${textarea.value.trim()}\n${newText}`;
                });
            });

            // Supervisor Login
            document.getElementById('login-button').addEventListener('click', () => {
                if (document.getElementById('supervisor-key').value === SUPERVISOR_KEY) {
                    document.getElementById('supervisor-login').classList.add('hidden');
                    document.getElementById('supervisor-dashboard').classList.remove('hidden');
                } else { showMessage('Clave incorrecta.', 'error'); }
            });

            // Admin Section Login
            document.getElementById('admin-login-button').addEventListener('click', () => {
                if (document.getElementById('admin-key').value === SUPERVISOR_KEY) {
                    document.getElementById('admin-login').classList.add('hidden');
                    document.getElementById('admin-controls').classList.remove('hidden');
                } else { showMessage('Clave incorrecta.', 'error'); }
            });

            // Filter Buttons
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                document.getElementById('coordinatorFilter').value = '';
                document.getElementById('locationFilter').value = '';
                document.getElementById('filterStartDate').value = '';
                document.getElementById('filterEndDate').value = '';
                applyFilters();
                document.getElementById('reportContainer').innerHTML = '';
            });
            document.getElementById('generateReportBtn').addEventListener('click', generateDetailedReport);
            
            // Management Modal
            const managementModal = document.getElementById('managementModal');
            const modalTitle = document.getElementById('managementModalTitle');
            const listContainer = document.getElementById('managementList');
            const newItemInput = document.getElementById('newItemInput');
            const addNewItemBtn = document.getElementById('addNewItemBtn');
            let currentList = '';

            const openManagementModal = (listName, title) => {
                currentList = listName;
                modalTitle.textContent = title;
                newItemInput.value = '';
                
                const items = listName === 'clients' ? allClientsList : allCoordinatorsList;
                listContainer.innerHTML = items.length > 0 ? items.map(item => `
                    <li class="flex justify-between items-center p-2 bg-gray-100 rounded">
                        <span>${item.name}</span>
                        <button data-id="${item.id}" data-name="${item.name}" class="delete-item-btn text-red-500 hover:text-red-700 font-bold">X</button>
                    </li>
                `).join('') : '<p class="text-center text-gray-500">No hay elementos.</p>';

                managementModal.classList.remove('hidden');
            };

            document.getElementById('manageClientsBtn').addEventListener('click', () => openManagementModal('clients', 'Gestionar Clientes'));
            document.getElementById('manageCoordinatorsBtn').addEventListener('click', () => openManagementModal('coordinators', 'Gestionar Responsables'));
            
            addNewItemBtn.addEventListener('click', () => {
                addListItem(currentList, newItemInput.value);
                newItemInput.value = '';
            });

            // Delete confirmation logic
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const itemToDeleteName = document.getElementById('itemToDeleteName');

            listContainer.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-item-btn');
                if (deleteButton) {
                    const itemId = deleteButton.dataset.id;
                    const itemName = deleteButton.dataset.name;
                    
                    itemToDeleteName.textContent = `"${itemName}"`;
                    confirmDeleteModal.classList.remove('hidden');

                    confirmDeleteBtn.onclick = async () => {
                        showSpinner(true);
                        try {
                            await deleteDoc(doc(db, currentList, itemId));
                            showMessage('Elemento eliminado.', 'info');
                        } catch (error) {
                            console.error("Error deleting item:", error);
                            showMessage('No se pudo eliminar el elemento.', 'error');
                        } finally {
                            showSpinner(false);
                            confirmDeleteModal.classList.add('hidden');
                            confirmDeleteBtn.onclick = null;
                        }
                    };
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                confirmDeleteModal.classList.add('hidden');
                confirmDeleteBtn.onclick = null;
            });

            document.getElementById('closeManagementModalBtn').addEventListener('click', () => managementModal.classList.add('hidden'));

            // Edit Report Modal
            const editModal = document.getElementById('editReportModal');
            document.getElementById('closeModalBtn').addEventListener('click', () => editModal.classList.add('hidden'));
            document.getElementById('cancelEditBtn').addEventListener('click', () => editModal.classList.add('hidden'));
            document.getElementById('saveAndDownloadBtn').addEventListener('click', async () => {
                 if (typeof window.htmlToDocx === 'undefined') {
                    console.error("html-to-docx library not loaded or attached to window.");
                    return showMessage("Error: La librería de exportación no se cargó. Refresque la página e intente de nuevo.", "error");
                }
                showSpinner(true);
                try {
                    const content = document.getElementById('editableReportContent').innerHTML;
                    const sourceHTML = `<!DOCTYPE html><html><head><meta charset='utf-8'><title>Informe</title></head><body>${content}</body></html>`;
                    const fileBuffer = await window.htmlToDocx.asBlob(sourceHTML);
                    window.saveAs(fileBuffer, 'informe_sha_generado.docx');
                } catch(e) {
                    console.error("Error generating docx:", e);
                    showMessage("Error al generar el documento.", "error");
                } finally {
                    showSpinner(false);
                    editModal.classList.add('hidden');
                }
            });
        }

        // Wait for the entire page to load, including all external scripts, before running the main script
        if (document.readyState === 'loading') {
            window.addEventListener('load', main);
        } else {
            main();
        }
        
    </script>
</body>
</html>

